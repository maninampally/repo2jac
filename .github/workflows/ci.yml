name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Backend: Python syntax + import checks ──────────────────
  backend:
    name: Backend (Python 3.11)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          # Install a subset of deps needed for syntax/import checks
          # (skip jaclang — heavy and not needed for CI checks)
          pip install fastapi uvicorn pydantic python-dotenv \
                      anthropic PyGithub aiofiles requests httpx

      - name: Syntax check all Python files
        working-directory: backend
        run: |
          python -m compileall -q .

      - name: Check critical imports resolve
        working-directory: backend
        env:
          PYTHONPATH: .
          ANTHROPIC_API_KEY: sk-ant-placeholder
          GITHUB_TOKEN: placeholder
        run: |
          python -c "from api.main import app; print('✅ main.py imports OK')"
          python -c "from core.pipeline import run_pipeline; print('✅ pipeline imports OK')"
          python -c "from core.job_store import create_job; print('✅ job_store imports OK')"
          python -c "from utils.github_client import fetch_repo_files; print('✅ github_client imports OK')"
          python -c "from utils.zip_builder import build_zip; print('✅ zip_builder imports OK')"
          python -c "from utils.syntax_validator import validate_jac_syntax; print('✅ syntax_validator imports OK')"

      - name: Validate docker-compose syntax
        working-directory: .
        run: |
          pip install docker-compose 2>/dev/null || true
          python -c "import yaml; yaml.safe_load(open('docker-compose.yml'))" && echo "✅ docker-compose.yml is valid YAML"

  # ── Frontend: Next.js build check ───────────────────────────
  frontend:
    name: Frontend (Node 18)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Next.js app
        working-directory: frontend
        env:
          # Dummy value — build will succeed without a real backend
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm run build

      - name: Check for unused dependencies (audit)
        working-directory: frontend
        run: npm audit --audit-level=critical
        # Only fails on critical CVEs
        continue-on-error: false
