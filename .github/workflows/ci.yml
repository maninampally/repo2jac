name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Backend: Python syntax + import checks ──────────────────
  backend:
    name: Backend (Python 3.11)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          # Install from requirements.txt but skip jaclang (heavy runtime dep, not needed for CI checks)
          grep -v '^jaclang' requirements.txt | pip install -r /dev/stdin

      - name: Syntax check all Python files
        working-directory: backend
        run: |
          python -m compileall -q .

      - name: Check critical imports resolve
        working-directory: backend
        env:
          PYTHONPATH: .
          ANTHROPIC_API_KEY: sk-ant-placeholder
          GITHUB_TOKEN: placeholder
        run: |
          python -c "from api.main import app; print('✅ main.py imports OK')"
          python -c "from core.pipeline import run_pipeline; print('✅ pipeline imports OK')"
          python -c "from core.job_store import create_job; print('✅ job_store imports OK')"
          python -c "from utils.github_client import fetch_repo_files; print('✅ github_client imports OK')"
          python -c "from utils.zip_builder import build_zip; print('✅ zip_builder imports OK')"
          python -c "from utils.syntax_validator import validate_jac_syntax; print('✅ syntax_validator imports OK')"

      - name: Validate docker-compose syntax
        working-directory: .
        run: |
          pip install pyyaml --quiet
          python -c "import yaml; yaml.safe_load(open('docker-compose.yml')); print('✅ docker-compose.yml is valid YAML')"

  # ── Frontend: Next.js build check ───────────────────────────
  frontend:
    name: Frontend (Node 18)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Next.js app
        working-directory: frontend
        env:
          # INTERNAL_API_URL is read server-side by next.config.js rewrites
          # NEXT_PUBLIC_API_URL kept for any client-side fallback references
          INTERNAL_API_URL: http://localhost:8000
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm run build

      - name: Check for unused dependencies (audit)
        working-directory: frontend
        run: npm audit --audit-level=critical
        # Only fails on critical CVEs
        continue-on-error: false
